参考资料：游戏引擎架构

## 0x01 骨骼

蒙皮上的三角网格顶点按权重绑定至多个关节，当关节移动时，蒙皮跟随骨骼进行拉伸

骨骼层级树结构在内存中的表示

一个数组，索引由0~N-1，存储所有的关节，每个关节节点都维护了一个父节点索引

> 每个关节只有一个父节点，根节点的父节点索引为-1

关节数组的存储次序一般是父关节在子关节之前，这意味着第一个数组元素是根节点

> 用“关节索引”来作为关节的标识，而不是关节的名字，提高性能

关节数据结构

- 关节名字，字符串
- 父节点索引
- 绑定姿势的逆变换

> 绑定姿势指的是

典型的骨骼数据结构

```cpp
//关节
struct Joint{
  Matrix4x3   m_invBindPose; //绑定姿势的逆变换【】
  const char* m_name;        //关节名字
  U8 		  m_iParent;     //父索引，0xFF表示根节点
};

//骨骼，保存所有关节的信息
struct Skeleton
{
    U32		  m_jointCount;  //关节数目
    Joint*    m_aJoint; 	 //关节数组
}
```

## 0x02 姿势

一个关节的姿势被定义为相对某参考系的位置、定向、缩放；通常以SQT数据格式表示。

#### 绑定姿势（T-pose）

绑定姿势是三维网格绑定至骨骼前的姿势，此姿势中四肢远离身体，较容易把顶点绑定至关节。所以一般是在骨骼呈绑定姿势时，将蒙皮绑定至骨骼

>  只有绑定姿势不会导致蒙皮变形

局部姿势

局部姿势是相对父关节的姿势，每个关节是一个坐标空间。关节姿势是一个仿射变换，第$j$个关节姿的姿势可表示为一个$4\times4$的仿射变换矩阵$P_j$，此矩阵包括

- 一个平移矢量$T_j$
- $3\times3$对角缩放矩阵$S_j$
- $3\times3$旋转矩阵$R_j$

$$
P_j=
\begin{equation}
\left[
\begin{array}{cc}
	S_jR_j & 0\\
	T_j & 1\\
\end{array}
\right]
\end{equation}
$$

内存中的关节姿势：

```cpp
//关节姿势
struct JointPose
{
  Quaternion m_rot;     //Q（旋转四元数）
  Vector3    m_trans;   //T（平移）
  F32		 m_scale;   //S（统一缩放）
};

//骨骼姿势
struct SkeletonPose
{
  Skeleton*		m_pSkeleton;   //骨骼+关节数量
  JointPose* 	m_aLoclPose;   //多个局部关节姿势
};
```

全局姿势

将关节姿势表示到模型空间或世界空间，即为全局姿势。某关节的模型空间姿势`（j->M）`，在该关节到根节点的路径上，由各个关节的局部姿势累乘计算得出，每次乘法迭代可理解成`i`变成`p(i)`

> 函数`p(i)`回传关节`i`的父索引

![aa](https://raw.githubusercontent.com/Vio1ette/blog-img/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220422092753.jpg)

$p(0)=M$，关节$J_2$的模型空间姿势可写成：
$$
P_{2\rightarrow M}=P_{2\rightarrow 1}P_{1\rightarrow 0}P_{0\rightarrow M}
$$
类似的，关节$J_5$的模型空间姿势可写成：
$$
P_{5\rightarrow M}=P_{5\rightarrow 4}P_{4\rightarrow 3}P_{3\rightarrow 0}P_{0\rightarrow M}
$$

## 0x03 动画片段

#### 动画片段

动画电影中，整个场景会以一串很长的、连续的帧来产生动画。但游戏中没法这么做，游戏中人物的各种动作被拆分为大量小粒度的动作，称为动画片段。例如跳跃、蹲下、跑步就是一个个动画片段。

#### 局部时间线

每个动画片段都有自己的时间线，称为局部时间线，比如跳跃的局部时间线，从跳起开始，到落地结束。

#### 姿势插值、关键帧、连续时间

动画师会制作一些关键时间点的姿势，称为关键帧，然后其他普通时间点的姿势由插值得到

![微信图片_20220422101527](https://raw.githubusercontent.com/Vio1ette/blog-img/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220422101527.jpg)

动画片段的时间线是连续的，时间变量t是浮点数，而非整数。对浮点数时间进行插值时，得到的可能会是非整数帧，比如1.1、1.9等帧。

## 0x04 蒙皮

每顶点的蒙皮信息

每个顶点按权重绑定一个或多个关节，如果只绑定到一个关节，则顶点完全跟随该关节移动；如果绑定至多个关节，则最终顶点的位置是一个加权平均的结果

> 顶点的位置 = 把它逐一绑定至各个关节后的位置 的加权平均【说的不清楚】

一个顶点一般绑定至4个关节，原因如下：

- 4个8位关节索引组成一个32位字
- 每顶点绑定至2，3，4个关节时产生的质量差别比较明显，而超过4个关节的绑定所提升的质量不那么明显（边际效应）

典型的蒙皮顶点数据结构

```cpp
float
```

蒙皮涉及的数学知识

蒙皮矩阵（skinning matrix）：把网格顶点从骨骼的<u>绑定姿势</u>变换至骨骼的<u>当前姿势</u>，变换前后顶点都在模型空间

蒙皮顶点的位置是在模型空间中定义的，无论其骨骼是绑定姿势或任意姿势。蒙皮矩阵会把顶点从绑定姿势的模型空间变换至当前姿势的模型空间。蒙皮矩阵在模型空间中变换顶点的位置，并非“基变更”，顶点在变换前后都在模型空间

单个关节骨骼的例子

![image-20220422110035592](https://raw.githubusercontent.com/Vio1ette/blog-img/main/image-20220422110035592.png)

要记住，顶点随骨骼关节移动，顶点在关节局部空间中的相对坐标是不变的。

例如

![image-20220422112458087](https://raw.githubusercontent.com/Vio1ette/blog-img/main/image-20220422112458087.png)

**绑定姿势**下，顶点 $V_M^B$ 在模型空间中的坐标为（4, 6），将此坐标变换到关节局部空间下，要用到$B_{j\rightarrow M}$矩阵，它把点从关节`j`局部空间变换到模型空间。现在的需求是将模型空间中的点变换到关节局部空间下，所以要用到它的逆矩阵，即$B_{M\rightarrow j}={(B_{j\rightarrow M})}^{-1}$
$$
v_j=v_M^B{(B_{j\rightarrow M})}^{-1}
$$

> 注意目前做的所有操作都是在绑定姿势下

假设得到$v_j$为（1, 3），下面进行关节姿势变换，即从绑定姿势移动到当前姿势

**在当前姿势下**，顶点在关节局部空间中的坐标仍为（1, 3），下面要将点坐标变换为模型空间。设在当前姿势下，将点从关节局部空间变换到模型空间所用的矩阵为$C_{j\rightarrow M}$
$$
v_M^C=v_j{C_{j\rightarrow M}}
$$
整合一下
$$
\begin{align}
v_M^C&=v_j{C_{j\rightarrow M}}\\
&=v_M^B{(B_{j\rightarrow M})}^{-1}C_{j\rightarrow M}\\
&=v_M^BK_j
\end{align}
$$
其中，$K_j={(B_{j\rightarrow M})}^{-1}C_{j\rightarrow M}$就称为蒙皮矩阵