四元数

why?:star:

为了方便地表示三维中任意的旋转

且用四元数在旋转值之间插值更加平滑、自然【四元数插值】

what

顾名思义，四元数是个四维矢量，有四个分量
$$
q=[q_x,\ q_y,\ q_z,\ q_w]
$$
#### 一、单位四元数

<u>单位长度</u>的四元数（$q_x^2+q_y^2+q_z^2+q_w^2=1$）能表示三维旋转。四个分量是由<u>一个三维矢量</u>和<u>一个标量</u>构成
$$
\begin{eqnarray}
q&=&[qV\quad qS]\\
&=&[\vec\alpha\, sin\,\frac{\theta}{2}\quad cos\,\frac{\theta}{2}]
\end{eqnarray}
$$
其中$\vec\alpha$是旋转轴矢量，$\theta$是旋转角度，四维表示：$[a_xsin\frac{\theta}{2},\ a_ysin\frac{\theta}{2},\ a_zsin\frac{\theta}{2},\ cos\frac{\theta}{2}]$

> 注意只有单位四元数才能代表三维旋转，例如两个四元数的加和并不能代表三维旋转，因为它们不是单位长度的fenbie

#### 二、四元数运算（how）

##### 1. 四元数乘法

对于两个四元数p，q，表示为 $q=[qV\quad qS],\quad p=[pV\quad pS]$，pq代表两个旋转的<u>合成旋转</u>，先旋转p，再旋转q。这里讨论的四元数乘法为格拉斯曼积
$$
pq=[(pS*qV+qS*pV+pV\times qV)\quad (pS*qS-pV\cdot qV)]
$$
结果仍用四元数来表示，第一个小括号里的结果是一个矢量，第二个小括号里的结果为标量

##### 2. 共轭及逆四元数

四元数q的逆记为$q^{-1}$，逆四元数和原四元数的乘积结果为标量1，即 $qq^{-1}=0i+0j+0k+1$，四元数$[0,0,0,1]$表示零旋转，旋转角为0。

共轭四元数$q^*=[-qV\quad qS]$，即矢量部分反向，标量部分不变

逆四元数$q^{-1}$定义为：
$$
q^{-1}=\frac{q^*}{|q|^2}
$$
分母为四元数的<u>模</u>，定义为<u>四个分量的平方和再开根号</u>，即$\sqrt{(q_x)^2+(q_y)^2+(q_z)^2+(q_w)^2}$，单位四元数的模为1，所以其逆=共轭，$q^{-1}=q^*$

积的共轭、逆：（和矩阵类似）
$$
(pq)^*=q^*p^*\\
(pq)^{-1}=q^{-1}p^{-1}
$$

##### 3. 以四元数旋转矢量

首先要把矢量写成四元数的形式，把其标量部分设为0。若有一矢量v，其对应的四元数为$V=[v\quad0]=[v_x\quad v_y\quad v_z \quad0]$，旋转后的矢量v'为：
$$
v'=rotate(q,v)=qvq^{-1}=qvq^*
$$
因为用来旋转的四元数都是单位四元数，所以用共轭和逆都可以

嵌套旋转，先旋转1，再旋转2，最后旋转3，$v'=q_3q_2q_1vq_1^{-1}q_2^{-1}q_3^{-1}$

##### 4. 四元数的等价矩阵

任何表示三维旋转的<u>四元数</u>和<u>3X3矩阵</u>之间都可以<u>自由转换</u>，（最初学三维旋转的时候，用的表达方式就是3X3矩阵），具体公式我懒得打了，参考《游戏引擎架构 第二版》第181页

##### 5. 旋转性的线性插值

对四元数进行插值，可以简单地套用对四维矢量的线性插值

> - 插值都需要有一个媒介作为插值参数，想下做过的以重心坐标为媒介的插值，或者以两点间距离作为媒介的插值。类推旋转就是以角度为媒介进行插值，已知旋转前角度和旋转后角度，中间的角度已知，现在可以求出中间的角度在整个角度范围中的占比（0~1）作为插值的参数
>
> - 对四元数的插值可以分解为对每一个分量的插值，对矢量的插值可以分解为对 x, y, z 三个分量上的插值，都可以分解到对标量进行插值，例如 a 和 b 之间的值，可以写为：`c=ta+(1-t)b`，`t`就是媒介参数
>
> - 突然想到，动画关键帧之间的插值可以以<u>时间</u>为媒介啊！

给定两个四元数 $q_A$ 和 $q_B$，可找出在旋转 A 和旋转 B 之间 $\beta$ 百分点的中间旋转 $q_{LERP}$
$$
q_{LERP}=LERP(q_A,q_B,\beta)=\frac{(1-\beta)q_A+\beta q_B}{|(1-\beta)q_A+\beta q_B|}=normalize\left(
{\begin{bmatrix}
(1-\beta)q_{A_x}+\beta q_{B_x}\\
(1-\beta)q_{A_y}+\beta q_{B_y}\\
(1-\beta)q_{A_z}+\beta q_{B_z}\\
(1-\beta)q_{A_w}+\beta q_{B_w}\\
\end{bmatrix}}^T\right)
$$
这里的分母跟插值无关，是用来插值后进行归一化的，从数学的角度，`LERP`函数就是对两个四元数的加权平均，权重为 $1-\beta$ 和 $\beta$

![image-20220514160554991](https://raw.githubusercontent.com/Vio1ette/blog-img/main/image-20220514160554991.png)

##### 6. 球面线性插值

四元数其实是一个四维超球面上的点，上述`LERP`只是在超球的弦上进行插值，而不是在超球面上进行插值，在弦上插值就会引入误差，当 $\beta$ 以恒定速率改变时，旋转动画并非以恒定角速率进行，但由于`LERP`开销比较小，效果也还行，所以也常被采用

球面线性插值，`SLERP`（s表示spherical）