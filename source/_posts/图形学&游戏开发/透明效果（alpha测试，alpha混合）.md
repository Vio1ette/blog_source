透明效果

参考资料：Unity Shader入门精要第8章

Unity中的alpha测试函数：clip，alpha混合命令：Blend

### 1. alpha测试

alpha测试比较简单‘粗糙，它判断像素的alpha通道是否满足条件（小于某个阈值），如果是，就不对这个物体进行渲染，否则就正常渲染。这种方式没法实现半透明的效果，所以alpha混合用的多一些。

### 2. alpha混合

#### 2.1 取消z-write

为了实现半透明效果，即能透过半透明物体看到后面的不透明物体（半透明物体离摄像机更近），必须取消半透明物体的深度写入，否则进行深度测试之后，将判定半透明物体遮挡住后面的不透明物体，后面的不透明物体就无法渲染

>  如果开启了深度写入，深度缓冲里保存的就是半透明物体的深度，按道理来讲，颜色缓冲应该和深度缓冲对应，即应该保存半透明物体的颜色，但这样就没办法看到后面的不透明物体的颜色了。所以关闭半透明物体的深度写入功能，即半透明物体对深度缓冲是只读的

#### 2.2 注意渲染顺序的重要性

##### 2.2.1 半透明物体和不透明物体

![0CD49E095BA9CD240B3603CD9F463AA0](https://raw.githubusercontent.com/Vio1ette/blog-img/main/0CD49E095BA9CD240B3603CD9F463AA0.png)

在已经取消z-write的情况下，如果先渲染A，没有深度写入，将A的颜色写入颜色缓冲区。在渲染B时，深度写入被打开，此时B会发现自己的深度是最近的（深度缓冲区为空），所以它的颜色会直接写入帧缓冲区，将会覆盖A的颜色，得到了错误的效果。

<u>所以要先渲染不透明物体，再渲染半透明物体</u>

B正常渲染，渲染A时，进行正常的深度测试，判断出A更近，将A的alpha通道的值和颜色缓冲区的值（B的颜色）进行混合（具体实现细节还需要查资料），最终正确实现半透明效果。

##### 2.2.2 半透明物体和半透明物体

![C590C84FA1ED2D7BD42EC4EC2BA0EA48](https://raw.githubusercontent.com/Vio1ette/blog-img/main/C590C84FA1ED2D7BD42EC4EC2BA0EA48.png)

先渲染B，将B的颜色写入颜色缓冲区，但不进行深度写入，再渲染A，进行深度测试判断A更近，将A和颜色缓冲区的B的颜色混合，得到正确的透明效果。由于没有深度写入，先渲染A再渲染B将会得到一个错误的半透明效果（看起来B是在A的前面）

<u>所以要先渲染远处的半透明物体，再渲染近的半透明物体</u>

### 3. 渲染引擎的一般处理方法

1. 正常渲染所有不透明物体
2. 将半透明物体按离摄像机的远近排序，先渲染远的，再渲染近的

问题：深度缓冲中的值是像素级别的，对物体进行排序时不能依赖像素级别的深度值。难以排序的情况：物体互相重叠，

解决方案：分割网格、模型拆解

### 4. 开启深度写入的半透明效果

两个Pass

第一个Pass：开启深度写入，单纯记录深度，但不输出颜色

第二个Pass：依据像素级深度值排序结果进行透明度混合

以前的方法要得到半透明物体的排序结果，现在进行像素级排序，而非整个物体

### 5. 半透明物体的阴影

